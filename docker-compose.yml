# =============================================================================
# Docker Compose Configuration for Books API
# =============================================================================
# This file defines all services needed to run the Books API locally.
#
# SECURITY NOTE:
# This configuration uses environment variables for ALL credentials.
# Copy .env.example to .env and configure with your secure values BEFORE starting.
#
# USAGE:
#   # First time setup:
#   cp .env.example .env
#   # Edit .env with your secure credentials (see SETUP.md)
#
#   # Start all services
#   docker-compose up -d
#
#   # View logs
#   docker-compose logs -f
#
#   # Stop all services
#   docker-compose down
#
#   # Stop and remove volumes (reset data)
#   docker-compose down -v
#
# SERVICES (Phase 1):
# 1. api: The FastAPI application (port 8001)
# 2. db: PostgreSQL database (port 5433)
#
# PHASE 2 SERVICES (not yet implemented):
# - redis: Caching & rate limiting (see commented section below)
#
# HOW SERVICES COMMUNICATE:
# - All services are on the same Docker network (books-network)
# - Services can reach each other by service name (e.g., api connects to 'db')
# - Custom ports are used to avoid conflicts with local services
#
# CUSTOM PORTS (security best practice - avoid defaults):
# - API: 8001 (instead of default 8000)
# - PostgreSQL: 5433 (instead of default 5432)

services:
  # ===========================================================================
  # API Service (FastAPI Application)
  # ===========================================================================
  api:
    build:
      context: .
      dockerfile: Dockerfile
      target: production  # Use the production stage
    container_name: books-api
    # Restart policy: always restart unless manually stopped
    restart: unless-stopped
    ports:
      # Map host port to container port
      # Format: "host:container"
      # Using custom port 8001 to avoid conflicts with local services
      - "${API_PORT:-8001}:8000"
    environment:
      # =======================================================================
      # SECURITY: All credentials loaded from environment variables
      # =======================================================================
      # Database URL constructed from individual env vars for flexibility
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@db:5432/${POSTGRES_DB}
      # Application settings
      - APP_NAME=${APP_NAME:-Books API}
      - DEBUG=${DEBUG:-False}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - SECRET_KEY=${SECRET_KEY}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-http://localhost:3000}
      # -----------------------------------------------------------------------
      # Phase 2: Redis configuration (uncomment when implementing caching)
      # - REDIS_URL=redis://redis:6379/0
      # - CACHE_TTL=${CACHE_TTL:-300}
      # -----------------------------------------------------------------------
    # Wait for database to be ready before starting
    depends_on:
      db:
        condition: service_healthy
      # Phase 2: Uncomment when adding Redis
      # redis:
      #   condition: service_healthy
    # Mount local code for development (hot reload)
    volumes:
      - .:/app
    # Use custom network
    networks:
      - books-network
    # Health check for the API
    healthcheck:
      test: ["CMD", "python", "-c", "import httpx; httpx.get('http://localhost:8000/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ===========================================================================
  # Database Service (PostgreSQL)
  # ===========================================================================
  # SECURITY: Uses custom credentials and port (not defaults)
  db:
    image: postgres:16-alpine
    container_name: books-db
    restart: unless-stopped
    environment:
      # =======================================================================
      # SECURITY: All credentials loaded from environment variables
      # NEVER use default 'postgres' user/password in production!
      # =======================================================================
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
      # Performance tuning for development
      POSTGRES_INITDB_ARGS: "--encoding=UTF8"
    # Persist data in a named volume
    volumes:
      - postgres_data:/var/lib/postgresql/data
    # Expose port to host for direct database access
    # Using custom port 5433 to avoid conflicts with local PostgreSQL
    ports:
      - "${POSTGRES_PORT:-5433}:5432"
    networks:
      - books-network
    # Health check to verify database is ready
    # Uses environment variables for user and database
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ===========================================================================
  # Phase 2: Redis Service (Caching & Rate Limiting)
  # ===========================================================================
  # UNCOMMENT THIS SECTION WHEN IMPLEMENTING PHASE 2 FEATURES:
  # - Response caching
  # - Rate limiting
  # - Session storage
  #
  # redis:
  #   image: redis:7-alpine
  #   container_name: books-redis
  #   restart: unless-stopped
  #   # Redis configuration for development
  #   command: redis-server --appendonly yes
  #   # Persist data in a named volume
  #   volumes:
  #     - redis_data:/data
  #   # Expose port to host for direct Redis access (development only)
  #   ports:
  #     - "${REDIS_PORT:-6379}:6379"
  #   networks:
  #     - books-network
  #   # Health check to verify Redis is ready
  #   healthcheck:
  #     test: ["CMD", "redis-cli", "ping"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5
  #     start_period: 5s

# =============================================================================
# Networks
# =============================================================================
# Custom bridge network for service communication
networks:
  books-network:
    driver: bridge
    name: books-network

# =============================================================================
# Volumes
# =============================================================================
# Named volumes persist data between container restarts
volumes:
  postgres_data:
    name: books-postgres-data
  # Phase 2: Uncomment when adding Redis
  # redis_data:
  #   name: books-redis-data
