# =============================================================================
# Continuous Integration Workflow
# =============================================================================
# This workflow runs automatically on:
# - Every push to main branch
# - Every pull request to main branch
#
# It performs:
# 1. Code linting (ruff) - checks code style and common errors
# 2. Type checking (mypy) - optional, validates type hints
# 3. Unit tests (pytest) - runs test suite against PostgreSQL
#
# The workflow uses GitHub's service containers to spin up a real
# PostgreSQL database for testing, ensuring tests run in an environment
# similar to production.
# =============================================================================

name: CI

# When to run this workflow
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# Environment variables available to all jobs
env:
  PYTHON_VERSION: "3.11"

jobs:
  # ===========================================================================
  # Linting Job
  # ===========================================================================
  # Runs code quality checks (fast, no database needed)
  lint:
    name: Lint
    runs-on: ubuntu-latest

    steps:
      # Step 1: Check out the repository code
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Set up Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      # Step 3: Install linting tools
      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip
          pip install ruff

      # Step 4: Run ruff linter
      - name: Run ruff
        run: ruff check app/ tests/ --output-format=github

  # ===========================================================================
  # Testing Job
  # ===========================================================================
  # Runs the test suite against a real PostgreSQL database
  test:
    name: Test
    runs-on: ubuntu-latest

    # Service containers to run alongside the job
    services:
      # PostgreSQL service container
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: test_books
        # Health check to wait for PostgreSQL to be ready
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        # Map port 5432 in the container to a random port on the host
        ports:
          - 5432:5432

      # Redis service container (for caching tests)
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    # Environment variables for the test job
    env:
      # Database configuration for tests
      DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_books
      # Redis configuration
      REDIS_URL: redis://localhost:6379/0
      # App configuration for tests
      SECRET_KEY: test-secret-key-for-ci-only-not-production
      ENVIRONMENT: development
      DEBUG: "false"
      API_KEY_ENABLED: "false"
      RATE_LIMIT_ENABLED: "false"

    steps:
      # Step 1: Check out the repository code
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Set up Python with caching
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      # Step 3: Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov httpx

      # Step 4: Run database migrations
      - name: Run migrations
        run: alembic upgrade head

      # Step 5: Run tests with coverage
      - name: Run tests
        run: |
          pytest tests/ -v --cov=app --cov-report=term-missing --cov-report=xml

      # Step 6: Upload coverage report (optional, for coverage tracking)
      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage.xml
          retention-days: 7

  # ===========================================================================
  # Build Job
  # ===========================================================================
  # Verifies the Docker image can be built successfully
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [lint, test]  # Only run after lint and test pass

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false  # Don't push, just verify it builds
          tags: books-api:test
          cache-from: type=gha
          cache-to: type=gha,mode=max
